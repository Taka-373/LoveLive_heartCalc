<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>ãƒ©ãƒ–ã‚« ãƒãƒ¼ãƒˆè¨ˆç®—</title>
  <link id="manifestLink" rel="manifest" href="manifest.webmanifest" />

  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; }
    * { box-sizing: border-box; }
    body { margin: 0; background: #0b1220; color: #e5e7eb; }
    header { position: sticky; top: 0; background: rgba(11,18,32,.9); backdrop-filter: blur(10px); border-bottom: 1px solid #1f2937; padding: 14px 16px; z-index: 10; }
    header h1 { margin: 0; font-size: 14px; letter-spacing: .04em; color: #cbd5e1; }
    main { padding: 14px 12px 40px; max-width: 980px; margin: 0 auto; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) { .row { grid-template-columns: 1fr 1fr; } }

    .card { background: #0f172a; border: 1px solid #1f2937; border-radius: 14px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .title { display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 10px; }
    .title h2 { margin: 0; font-size: 14px; color: #e2e8f0; }
    .muted { color: #94a3b8; font-size: 12px; }
    .mono { font-variant-numeric: tabular-nums; }
    .hr { height:1px; background:#1f2937; margin: 10px 0; }

    button, select, input { font: inherit; }
    button { background: #1f2937; color: #e5e7eb; border: 1px solid #334155; border-radius: 10px; padding: 10px 12px; cursor:pointer; }
    button.primary { background: #2563eb; border-color: #1d4ed8; }
    button.danger { background: #7f1d1d; border-color: #991b1b; }
    button.ghost { background: transparent; border-color: #334155; }
    button:disabled { opacity: .5; cursor:not-allowed; }

    select, input { background:#0b1220; border: 1px solid #334155; color:#e5e7eb; border-radius: 10px; padding: 10px 10px; }
    input { width: 100%; min-width: 0; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; border:1px solid #334155; background:#0b1220; font-size: 12px; color:#cbd5e1;}
    .kv { display:flex; flex-wrap:wrap; gap: 6px; margin-top: 8px; }

    .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .slot { border: 1px dashed #334155; border-radius: 12px; padding: 10px; min-height: 96px; background: rgba(15,23,42,.65); }
    .slot.filled { border-style: solid; }
    .slotHead { display:flex; align-items:center; justify-content:space-between; gap: 8px; }
    .slotName { font-size: 13px; color:#e2e8f0; }
    .controls { display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px; }
    .toggle { display:flex; gap:8px; }
    .toggle button { flex:1; }

    .result { padding: 12px; border-radius: 12px; border:1px solid #334155; background:#0b1220; }
    .ok { border-color: #166534; background: rgba(22,101,52,.18); }
    .ng { border-color: #991b1b; background: rgba(153,27,27,.16); }
    .big { font-size: 16px; font-weight: 800; }
    .list { margin: 8px 0 0; padding-left: 18px; color:#e2e8f0; }
    .footerHint { margin-top: 10px; color:#94a3b8; font-size: 12px; line-height: 1.4; }

    /* modal */
    .modalBack { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:999; padding: 10px; }
    .modal { max-width:560px; margin: 10vh auto; background:#0f172a; border:1px solid #334155; border-radius:14px; padding:12px; }
    .notice { padding: 10px; border-radius: 12px; border: 1px solid #334155; background: rgba(2,6,23,.3); }
    .hRow { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items:center; }
    .twoCol { display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    @media (max-width: 460px) { .twoCol { grid-template-columns: 1fr; } }

    /* Stepper: base (wide) */
    .stepper{
      display:grid;
      grid-template-columns:44px 1fr 44px;
      gap:8px;
      align-items:center;
      width:100%;
      min-width:0;
    }
    .stepper button{ padding:10px 0; border-radius:10px; font-weight:800; line-height:1; }
    .stepper input{ text-align:center; min-width:0; }

    /* â˜…iOS: ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€èƒŒé¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    .modalBack{
      overflow: hidden;
      touch-action: none;
    }
    .modal{
      max-height: 80vh;
      max-height: 80dvh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* â˜…ã‚¹ãƒãƒ›: æ‰‹å…¥åŠ›ç³»ã¯ç‹­ã„å¹…ã§ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ç¸¦ï¼ˆå…¥åŠ›ä¸Šæ®µã€Â±ä¸‹æ®µï¼‰ï¼‹ãƒ©ãƒ™ãƒ«ç¸¦ä¸¦ã³ */
    @media (max-width: 900px) {
      #manualInputs .stepper,
      #liveColoredInputs .stepper,
      #liveGrayWrap .stepper{
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "input input"
          "minus plus";
        gap: 6px;
      }

      #manualInputs .stepper button:nth-child(1),
      #liveColoredInputs .stepper button:nth-child(1),
      #liveGrayWrap .stepper button:nth-child(1){ grid-area: minus; }

      #manualInputs .stepper input:nth-child(2),
      #liveColoredInputs .stepper input:nth-child(2),
      #liveGrayWrap .stepper input:nth-child(2){ grid-area: input; }

      #manualInputs .stepper button:nth-child(3),
      #liveColoredInputs .stepper button:nth-child(3),
      #liveGrayWrap .stepper button:nth-child(3){ grid-area: plus; }

      #manualInputs .hRow,
      #liveColoredInputs .hRow{
        grid-template-columns: 1fr;
      }
    }

    /* â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è‰²å…¥åŠ›ã¯æ¨ªä¸¦ã³ï¼ˆ2åˆ—â†’åºƒã‘ã‚Œã°3åˆ—ï¼‰ */
    #manualInputs,
    #liveColoredInputs{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (min-width: 600px){
      #manualInputs,
      #liveColoredInputs{
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    #manualInputs .hRow,
    #liveColoredInputs .hRow{
      grid-template-columns: 1fr;
      gap: 6px;
      padding: 8px;
      border: 1px solid #1f2937;
      border-radius: 12px;
      background: rgba(2,6,23,.35);
    }

    /* ===== è‰²ä»˜ããƒ”ãƒ«ï¼ˆdata-colorï¼‰ ===== */
    .pill[data-color]{
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.14);
      color: #0b1220;
    }
    .pill[data-color="red"]    { background:#ef4444; }
    .pill[data-color="blue"]   { background:#60a5fa; }
    .pill[data-color="green"]  { background:#34d399; }
    .pill[data-color="yellow"] { background:#fbbf24; color:#111827; }
    .pill[data-color="purple"] { background:#c084fc; }
    .pill[data-color="pink"]   { background:#fb7185; }

    /* ===== å¿œæ´å…¥åŠ›ï¼š2åˆ—/3åˆ—ã‚°ãƒªãƒƒãƒ‰åŒ–ï¼ˆã“ã“ãŒä»Šå›ã®è¦æœ›ï¼‰ ===== */
    #supportFixed{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (min-width: 600px){
      #supportFixed{
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    /* å¿œæ´ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚«ãƒ¼ãƒ‰åŒ–ï¼ˆå…¥åŠ›å ´æ‰€ãŒè¿·ã‚ãªã„ï¼‰ */
    #supportFixed .hRow{
      grid-template-columns: 1fr;
      gap: 6px;
      padding: 8px;
      border: 1px solid #1f2937;
      border-radius: 12px;
      background: rgba(2,6,23,.35);
    }
    /* å¿œæ´ã ã‘ã¯å¸¸æ™‚ã€Œå…¥åŠ›ä¸Šæ®µãƒ»Â±ä¸‹æ®µã€ã«å›ºå®šï¼ˆè¿·ã‚ã›ãªã„ï¼‰ */
    #supportFixed .stepper{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "input input"
        "minus plus";
      gap: 6px;
    }
    #supportFixed .stepper button:nth-child(1){ grid-area: minus; }
    #supportFixed .stepper input:nth-child(2){ grid-area: input; }
    #supportFixed .stepper button:nth-child(3){ grid-area: plus; }

  </style>
</head>

<body>
<header><h1>ãƒ©ãƒ–ã‚« ãƒãƒ¼ãƒˆè¨ˆç®—ï¼ˆå ´1ã€œ3 / å¿œæ´ãƒ»ã‚³ã‚¹ãƒˆï¼ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ï¼‰</h1></header>

<main>
  <div class="row">
    <!-- Stage -->
    <section class="card">
      <div class="title">
        <h2>ã‚¹ãƒ†ãƒ¼ã‚¸</h2>
        <span class="pill mono" id="stageCount">å ´ï¼š0/3</span>
      </div>

      <div class="toggle">
        <button id="modeDbBtn" class="primary" type="button">DBã‹ã‚‰é¸ã¶ï¼ˆãƒ‡ãƒ¢ï¼‰</button>
        <button id="modeManualBtn" type="button">æ‰‹å…¥åŠ›ï¼ˆå…¨ç¨®é¡ï¼‰</button>
      </div>

      <div class="hr"></div>
      <div class="grid3" id="slots"></div>

      <div class="hr"></div>
      <div class="title" style="margin-bottom:6px;">
        <h2>å ´ åˆè¨ˆ</h2><span class="muted">ï¼ˆåŸºæœ¬ãƒãƒ¼ãƒˆï¼‰</span>
      </div>
      <div class="kv" id="stageSum"></div>

      <div class="footerHint">
        â€» å ´ãŒ0æšãªã‚‰è¨ˆç®—ä¸å¯ã€‚<br />
        â€» æœ¬ãƒ„ãƒ¼ãƒ«ã¯ã€Œæ•°å€¤è¨ˆç®—ã®ã¿ã€ã€‚åŠ¹æœ/è£å®š/ç”»åƒç­‰ã¯æ‰±ã„ã¾ã›ã‚“ã€‚
      </div>
    </section>

    <!-- Live & Support -->
    <section class="card">
      <div class="title">
        <h2>ãƒ©ã‚¤ãƒ–ï¼†å¿œæ´</h2>
        <span class="pill">ç„¡è‰²ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ï¼è‰²ä¸å•ã®å€‹æ•°</span>
      </div>

      <div class="notice">
        <div class="title" style="margin-bottom:6px;">
          <h2>ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰</h2>
          <div style="display:flex; gap:8px;">
            <button id="liveModePresetBtn" class="primary" type="button">ãƒ‡ãƒ¢é¸æŠ</button>
            <button id="liveModeManualBtn" class="ghost" type="button">æ‰‹å…¥åŠ›</button>
          </div>
        </div>

        <div id="livePresetBox">
          <select id="liveSelect" style="width:100%;"></select>
        </div>

        <div id="liveManualBox" style="display:none;">
          <div class="controls" style="margin-top:0;">
            <button id="openLiveModal" class="primary" type="button">ãƒ©ã‚¤ãƒ–ã‚³ã‚¹ãƒˆã‚’å…¥åŠ›</button>
            <button id="clearLiveManual" class="danger" type="button">æ‰‹å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
          </div>
          <div class="muted" style="margin-top:8px;">â€» è‰²æŒ‡å®š + ç„¡è‰²ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</div>
        </div>

        <div class="kv" id="liveCost"></div>
      </div>

      <div class="hr"></div>

      <div class="title" style="margin-bottom:6px;">
        <h2>å¿œæ´ï¼ˆã“ã“ã‚’å…¥åŠ›ï¼‰</h2>
        <button id="supportClearBtn" class="danger" type="button">å¿œæ´ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
      <div id="supportFixed"></div>

      <div class="title" style="margin-top:12px;margin-bottom:6px;">
        <h2>å¿œæ´ åˆè¨ˆ</h2>
      </div>
      <div class="kv" id="supportSum"></div>

      <div class="hr"></div>

      <div class="controls">
        <button id="calcBtn" class="primary" type="button">è¨ˆç®—</button>
        <button id="resetBtn" class="danger" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div style="margin-top:12px;" id="resultBox" class="result">
        <div class="big">æœªè¨ˆç®—</div>
        <div class="muted">å ´ãƒ»ãƒ©ã‚¤ãƒ–ãƒ»å¿œæ´ã‚’å…¥åŠ›ã—ã¦ã€Œè¨ˆç®—ã€ã€‚ä¸è¶³ã¯ã‚¿ãƒƒãƒ—ã§å¿œæ´ã«åŠ ç®—ã§ãã¾ã™ã€‚</div>
      </div>

      <div class="footerHint">
        ğŸ’¡ å¤±æ•—æ™‚ï¼šä¸è¶³ã‚’ã‚¿ãƒƒãƒ— â†’ å¿œæ´ã¸è‡ªå‹•åŠ ç®—ã€‚<br/>
        â€» ç„¡è‰²ä¸è¶³ã ã‘ã¯ã€åŠ ç®—ã™ã‚‹è‰²ã‚’é¸ã³ã¾ã™ï¼ˆä»•æ§˜ä¸Šï¼‰ã€‚
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:12px;">
    <div class="title"><h2>ä½¿ã„æ–¹ï¼ˆæœ€çŸ­ï¼‰</h2><span class="muted">iPhoneã§ã‚‚OK</span></div>
    <ol class="list">
      <li>å ´ã‚«ãƒ¼ãƒ‰ã‚’1ã€œ3æšå…¥ã‚Œã‚‹ï¼ˆDB or æ‰‹å…¥åŠ›ï¼‰</li>
      <li>ãƒ©ã‚¤ãƒ–ã‚’é¸ã¶ï¼ˆor æ‰‹å…¥åŠ›ï¼‰</li>
      <li>å¿œæ´ã¯å…¨è‰²ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼ã§è¶³ã™</li>
      <li>å¤±æ•—æ™‚ã¯ä¸è¶³ã‚’ã‚¿ãƒƒãƒ—ã§è‡ªå‹•åŠ ç®—</li>
    </ol>
  </section>
</main>

<!-- Stage manual modal -->
<div id="manualModal" class="modalBack" aria-hidden="true">
  <div class="modal">
    <div class="title">
      <h2 id="manualModalTitle">æ‰‹å…¥åŠ›</h2>
      <button id="manualClose" class="ghost" type="button">é–‰ã˜ã‚‹</button>
    </div>

    <input id="manualName" placeholder="åå‰ï¼ˆä»»æ„ï¼‰" style="width:100%;" />
    <div class="hr"></div>
    <div id="manualInputs"></div>

    <div class="controls" style="margin-top:12px; justify-content:flex-end;">
      <button id="manualCancel" class="ghost" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="manualSave" class="primary" type="button">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- Live manual modal -->
<div id="liveModal" class="modalBack" aria-hidden="true">
  <div class="modal">
    <div class="title">
      <h2>ãƒ©ã‚¤ãƒ–ã‚³ã‚¹ãƒˆï¼ˆæ‰‹å…¥åŠ›ï¼‰</h2>
      <button id="liveClose" class="ghost" type="button">é–‰ã˜ã‚‹</button>
    </div>

    <input id="liveName" placeholder="ãƒ©ã‚¤ãƒ–åï¼ˆä»»æ„ï¼‰" style="width:100%;" />

    <div class="hr"></div>
    <div class="muted">è‰²æŒ‡å®šã‚³ã‚¹ãƒˆ</div>
    <div id="liveColoredInputs" style="margin-top:8px;"></div>

    <div class="hr"></div>
    <div class="muted">ç„¡è‰²ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ã‚³ã‚¹ãƒˆï¼šè‰²ä¸å•ã®å€‹æ•°</div>
    <div id="liveGrayWrap" style="margin-top:8px;"></div>

    <div class="controls" style="margin-top:12px; justify-content:flex-end;">
      <button id="liveCancel" class="ghost" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="liveSave" class="primary" type="button">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Config / Demo Data
========================= */
const HEART_TYPES = [
  { key: "red",   label: "èµ¤" },
  { key: "blue",  label: "é’" },
  { key: "green", label: "ç·‘" },
  { key: "yellow",label: "é»„" },
  { key: "purple",label: "ç´«" },
  { key: "pink",  label: "ãƒ”ãƒ³ã‚¯" },
];

const DEMO_CARDS = [
  { id: "DEMO-001", name: "å ´ã‚«ãƒ¼ãƒ‰A", hearts: { red:1, blue:0, green:1, yellow:0, purple:0, pink:0 } },
  { id: "DEMO-002", name: "å ´ã‚«ãƒ¼ãƒ‰B", hearts: { red:0, blue:2, green:0, yellow:1, purple:0, pink:0 } },
  { id: "DEMO-003", name: "å ´ã‚«ãƒ¼ãƒ‰C", hearts: { red:1, blue:0, green:0, yellow:0, purple:1, pink:0 } },
];

const DEMO_LIVES = [
  { id: "LIVE-001", name: "ãƒ©ã‚¤ãƒ–â‘ ï¼ˆèµ¤2 é’1 + ç„¡è‰²2ï¼‰", cost: { red:2, blue:1, gray:2 } },
  { id: "LIVE-002", name: "ãƒ©ã‚¤ãƒ–â‘¡ï¼ˆç´«1 ãƒ”ãƒ³ã‚¯1 + ç„¡è‰²3ï¼‰", cost: { purple:1, pink:1, gray:3 } },
  { id: "LIVE-003", name: "ãƒ©ã‚¤ãƒ–â‘¢ï¼ˆç·‘2 é»„1 + ç„¡è‰²1ï¼‰", cost: { green:2, yellow:1, gray:1 } },
];

/* =========================
   State
========================= */
const state = {
  stageMode: "db",
  stage: [null, null, null],
  support: HEART_TYPES.reduce((o,t)=> (o[t.key]=0, o), {}),
  liveMode: "preset",
  livePresetId: DEMO_LIVES[0].id,
  liveManual: null, // { name, colored, gray }
};

/* =========================
   Utils
========================= */
const $ = (id) => document.getElementById(id);

const clampInt = (v, min=0) => {
  const n = Math.floor(Number(v || 0));
  return Number.isFinite(n) ? Math.max(min, n) : min;
};
const emptyHearts = () => HEART_TYPES.reduce((o,t)=> (o[t.key]=0, o), {});
const normHearts = (h) => {
  const out = emptyHearts();
  for (const k in (h||{})) if (k in out) out[k] = clampInt(h[k], 0);
  return out;
};
const sumHearts = (items) => {
  const out = emptyHearts();
  for (const it of items) {
    if (!it) continue;
    const h = normHearts(it.hearts);
    for (const k in out) out[k] += h[k];
  }
  return out;
};
const totalCount = (h) => Object.values(h).reduce((a,b)=>a+clampInt(b,0),0);
const esc = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* Stepper */
function makeStepper(initialValue, onChange, opts={}) {
  const wrap = document.createElement("div");
  wrap.className = "stepper";

  const minus = document.createElement("button");
  minus.className = "ghost"; minus.type="button"; minus.textContent="âˆ’";

  const plus  = document.createElement("button");
  plus.className  = "ghost"; plus.type="button";  plus.textContent="+";

  const input = document.createElement("input");
  input.type="number"; input.min="0"; input.step="1"; input.inputMode="numeric";
  input.className="mono";
  input.value = String(clampInt(initialValue, 0));
  if (opts.id) input.id = opts.id;
  if (opts.datasetKey) input.dataset.key = opts.datasetKey;

  const apply = (v) => { const nv = clampInt(v, 0); input.value = String(nv); onChange(nv, input); };

  minus.addEventListener("click", () => apply(Number(input.value)-1));
  plus.addEventListener("click",  () => apply(Number(input.value)+1));
  input.addEventListener("input", () => apply(input.value));

  wrap.append(minus, input, plus);
  return { wrap, input, apply };
}

function renderPills(container, heartsObj, {showZero=false, includeTotal=true, totalLabel="åˆè¨ˆ"} = {}) {
  container.innerHTML = "";
  for (const t of HEART_TYPES) {
    const v = clampInt(heartsObj[t.key], 0);
    if (!showZero && v === 0) continue;
    const el = document.createElement("span");
    el.className = "pill mono";
    el.textContent = `${t.label} ${v}`;
    container.appendChild(el);
  }
  if (includeTotal) {
    const el = document.createElement("span");
    el.className = "pill mono";
    el.textContent = `${totalLabel} ${totalCount(heartsObj)}`;
    container.appendChild(el);
  }
}

/* =========================
   Elements
========================= */
const slotsEl = $("slots");
const stageSumEl = $("stageSum");
const stageCountEl = $("stageCount");

const modeDbBtn = $("modeDbBtn");
const modeManualBtn = $("modeManualBtn");

const livePresetBox = $("livePresetBox");
const liveManualBox = $("liveManualBox");
const liveSelectEl = $("liveSelect");
const liveCostEl = $("liveCost");
const liveModePresetBtn = $("liveModePresetBtn");
const liveModeManualBtn = $("liveModeManualBtn");
const openLiveModalBtn = $("openLiveModal");
const clearLiveManualBtn = $("clearLiveManual");
const liveGrayWrap = $("liveGrayWrap");

const supportFixedEl = $("supportFixed");
const supportSumEl = $("supportSum");
const supportClearBtn = $("supportClearBtn");

const calcBtn = $("calcBtn");
const resetBtn = $("resetBtn");
const resultBox = $("resultBox");

/* =========================
   Stage mode
========================= */
function setStageMode(mode){
  state.stageMode = mode;
  modeDbBtn.classList.toggle("primary", mode==="db");
  modeManualBtn.classList.toggle("primary", mode==="manual");
  renderAll();
}
modeDbBtn.addEventListener("click", ()=>setStageMode("db"));
modeManualBtn.addEventListener("click", ()=>setStageMode("manual"));

/* =========================
   Live mode
========================= */
function setLiveMode(mode){
  state.liveMode = mode;
  liveModePresetBtn.classList.toggle("primary", mode==="preset");
  liveModeManualBtn.classList.toggle("primary", mode==="manual");
  liveModePresetBtn.classList.toggle("ghost", mode!=="preset");
  liveModeManualBtn.classList.toggle("ghost", mode!=="manual");

  livePresetBox.style.display = mode==="preset" ? "" : "none";
  liveManualBox.style.display = mode==="manual" ? "" : "none";
  renderAll(false);
}
liveModePresetBtn.addEventListener("click", ()=>setLiveMode("preset"));
liveModeManualBtn.addEventListener("click", ()=>setLiveMode("manual"));

function renderLiveSelect(){
  liveSelectEl.innerHTML = "";
  for (const l of DEMO_LIVES) {
    const opt = document.createElement("option");
    opt.value = l.id; opt.textContent = l.name;
    liveSelectEl.appendChild(opt);
  }
  liveSelectEl.value = state.livePresetId;
  liveSelectEl.addEventListener("change", ()=>{
    state.livePresetId = liveSelectEl.value;
    renderAll(false);
  });
}
function getLiveCost(){
  if (state.liveMode === "manual") {
    const m = state.liveManual;
    return m ? { name:m.name, colored:normHearts(m.colored), gray:clampInt(m.gray,0) }
             : { name:"æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–ï¼ˆæœªè¨­å®šï¼‰", colored:emptyHearts(), gray:0 };
  }
  const live = DEMO_LIVES.find(x=>x.id===state.livePresetId) || DEMO_LIVES[0];
  return { name: live.name, colored: normHearts(live.cost), gray: clampInt(live.cost.gray,0) };
}
function renderLiveCost(){
  const live = getLiveCost();
  liveCostEl.innerHTML = "";
  for (const t of HEART_TYPES) {
    const v = clampInt(live.colored[t.key],0);
    if (!v) continue;
    const el = document.createElement("span");
    el.className = "pill mono";
    el.textContent = `${t.label} å¿…è¦ ${v}`;
    liveCostEl.appendChild(el);
  }
  const g = document.createElement("span");
  g.className = "pill mono";
  g.textContent = `ç„¡è‰² å¿…è¦ ${clampInt(live.gray,0)}`;
  liveCostEl.appendChild(g);
}

/* =========================
   Manual modal (Stage)
========================= */
const manualModal = $("manualModal");
const manualModalTitle = $("manualModalTitle");
const manualInputsEl = $("manualInputs");
const manualNameEl = $("manualName");
const manualCloseBtn = $("manualClose");
const manualCancelBtn = $("manualCancel");
const manualSaveBtn = $("manualSave");
let manualEditingSlot = null;

function openManualModal(slotIdx, preset){
  manualEditingSlot = slotIdx;
  manualModalTitle.textContent = `æ‰‹å…¥åŠ›ï¼ˆæ ${slotIdx+1}ï¼‰`;
  manualNameEl.value = preset?.name ?? `å ´ã‚«ãƒ¼ãƒ‰${slotIdx+1}`;

  manualInputsEl.innerHTML = "";
  for (const t of HEART_TYPES) {
    const row = document.createElement("div");
    row.className = "hRow";

    const label = document.createElement("div");
    label.className = "pill";
    label.textContent = t.label;
    label.dataset.color = t.key;

    const { wrap } = makeStepper(preset?.hearts?.[t.key] ?? 0, ()=>{}, { datasetKey: t.key });
    row.append(label, wrap);
    manualInputsEl.appendChild(row);
  }

  manualModal.style.display = "block";
  manualModal.setAttribute("aria-hidden","false");
}
function closeManualModal(){
  manualModal.style.display = "none";
  manualModal.setAttribute("aria-hidden","true");
  manualEditingSlot = null;
}
manualCloseBtn.addEventListener("click", closeManualModal);
manualCancelBtn.addEventListener("click", closeManualModal);
manualModal.addEventListener("click", (e)=>{ if (e.target===manualModal) closeManualModal(); });

manualSaveBtn.addEventListener("click", ()=>{
  if (manualEditingSlot===null) return;

  const hearts = emptyHearts();
  manualInputsEl.querySelectorAll("input[data-key]").forEach(inp=>{
    hearts[inp.dataset.key] = clampInt(inp.value, 0);
  });

  const name = (manualNameEl.value||"").trim() || `å ´ã‚«ãƒ¼ãƒ‰${manualEditingSlot+1}`;
  state.stage[manualEditingSlot] = { source:"manual", name, hearts };

  closeManualModal();
  renderAll();
});

/* =========================
   Live modal (Manual)
========================= */
const liveModal = $("liveModal");
const liveCloseBtn = $("liveClose");
const liveCancelBtn = $("liveCancel");
const liveSaveBtn = $("liveSave");
const liveNameEl = $("liveName");
const liveColoredInputsEl = $("liveColoredInputs");

function openLiveModal(preset){
  liveNameEl.value = preset?.name ?? "æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–";

  liveColoredInputsEl.innerHTML = "";
  const colored = normHearts(preset?.colored || {});
  for (const t of HEART_TYPES) {
    const row = document.createElement("div");
    row.className = "hRow";

    const label = document.createElement("div");
    label.className = "pill";
    label.textContent = t.label;
    label.dataset.color = t.key;

    const { wrap } = makeStepper(colored[t.key] ?? 0, ()=>{}, { datasetKey: t.key });
    row.append(label, wrap);
    liveColoredInputsEl.appendChild(row);
  }

  liveGrayWrap.innerHTML = "";
  const { wrap: grayWrap } = makeStepper(preset?.gray ?? 0, ()=>{}, { id:"liveGray" });
  liveGrayWrap.appendChild(grayWrap);

  liveModal.style.display = "block";
  liveModal.setAttribute("aria-hidden","false");
}
function closeLiveModal(){
  liveModal.style.display = "none";
  liveModal.setAttribute("aria-hidden","true");
}
liveCloseBtn.addEventListener("click", closeLiveModal);
liveCancelBtn.addEventListener("click", closeLiveModal);
liveModal.addEventListener("click", (e)=>{ if (e.target===liveModal) closeLiveModal(); });

openLiveModalBtn.addEventListener("click", ()=>{
  const preset = state.liveManual
    ? { name: state.liveManual.name, colored: state.liveManual.colored, gray: state.liveManual.gray }
    : { name: "æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–", colored: emptyHearts(), gray: 0 };
  openLiveModal(preset);
});
clearLiveManualBtn.addEventListener("click", ()=>{
  if (!confirm("ãƒ©ã‚¤ãƒ–æ‰‹å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  state.liveManual = null;
  renderAll(false);
});
liveSaveBtn.addEventListener("click", ()=>{
  const colored = emptyHearts();
  liveColoredInputsEl.querySelectorAll("input[data-key]").forEach(inp=>{
    colored[inp.dataset.key] = clampInt(inp.value, 0);
  });
  const gray = clampInt($("liveGray")?.value, 0);
  const name = (liveNameEl.value||"").trim() || "æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–";
  state.liveManual = { name, colored, gray };
  closeLiveModal();
  renderAll(false);
});

/* =========================
   Stage slots render
========================= */
function addToSlot(i){
  if (state.stageMode==="db") {
    const picked = prompt(
      "ãƒ‡ãƒ¢ï¼šå ´ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠï¼ˆæ•°å­—ï¼‰\n" +
      DEMO_CARDS.map((c,idx)=>`${idx+1}: ${c.name}`).join("\n")
    );
    const n = Number(picked);
    if (!Number.isFinite(n) || n<1 || n>DEMO_CARDS.length) return;
    const c = DEMO_CARDS[n-1];
    state.stage[i] = { source:"db", name:c.name, hearts: normHearts(c.hearts) };
    renderAll();
    return;
  }
  openManualModal(i, { name:`å ´ã‚«ãƒ¼ãƒ‰${i+1}`, hearts: emptyHearts() });
}
function editSlot(i){
  const it = state.stage[i];
  if (!it) return;
  if (state.stageMode==="db" && it.source==="db") return addToSlot(i);
  openManualModal(i, { name: it.name, hearts: normHearts(it.hearts) });
}
function renderSlots(){
  slotsEl.innerHTML = "";
  const count = state.stage.filter(Boolean).length;
  stageCountEl.textContent = `å ´ï¼š${count}/3`;

  for (let i=0;i<3;i++){
    const it = state.stage[i];
    const slot = document.createElement("div");
    slot.className = "slot" + (it ? " filled" : "");

    const head = document.createElement("div");
    head.className = "slotHead";

    const name = document.createElement("div");
    name.className = "slotName mono";
    name.textContent = it ? it.name : `æ ${i+1}ï¼ˆæœªè¨­å®šï¼‰`;

    const right = document.createElement("div");
    right.style.display="flex"; right.style.gap="6px";

    if (it) {
      const edit = document.createElement("button");
      edit.className="ghost"; edit.type="button"; edit.textContent="ç·¨é›†";
      edit.addEventListener("click", ()=>editSlot(i));

      const del = document.createElement("button");
      del.className="danger"; del.type="button"; del.textContent="å‰Šé™¤";
      del.addEventListener("click", ()=>{ state.stage[i]=null; renderAll(); });

      right.append(edit, del);
    } else {
      const add = document.createElement("button");
      add.className="primary"; add.type="button"; add.textContent="+ è¿½åŠ ";
      add.addEventListener("click", ()=>addToSlot(i));
      right.append(add);
    }

    head.append(name, right);
    slot.appendChild(head);

    const kv = document.createElement("div");
    kv.className="kv";
    if (it) renderPills(kv, it.hearts, { includeTotal:false });
    slot.appendChild(kv);

    slotsEl.appendChild(slot);
  }

  renderPills(stageSumEl, sumHearts(state.stage), { totalLabel:"åˆè¨ˆ" });
}

/* =========================
   Support render (all stepper)
========================= */
function renderSupport(){
  supportFixedEl.innerHTML = "";
  for (const t of HEART_TYPES) {
    const row = document.createElement("div");
    row.className="hRow";

    const label = document.createElement("div");
    label.className="pill";
    label.textContent = t.label;
    label.dataset.color = t.key;

    const { wrap } = makeStepper(state.support[t.key] ?? 0, (nv)=>{
      state.support[t.key]=nv;
      renderAll(false);
    });

    row.append(label, wrap);
    supportFixedEl.appendChild(row);
  }
  renderPills(supportSumEl, state.support, { totalLabel:"åˆè¨ˆ" });
}
supportClearBtn.addEventListener("click", ()=>{
  if (!confirm("å¿œæ´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  for (const t of HEART_TYPES) state.support[t.key]=0;
  renderAll(false);
});

/* =========================
   Calc
========================= */
function calc(){
  const stageCount = state.stage.filter(Boolean).length;
  if (!stageCount) return { ok:false, reason:"å ´ã‚«ãƒ¼ãƒ‰ã‚’1æšä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚", detail:[] };

  const stage = sumHearts(state.stage);
  const support = normHearts(state.support);
  const available = emptyHearts();
  for (const k in available) available[k] = stage[k] + support[k];

  const live = getLiveCost();
  const req = normHearts(live.colored);
  const gray = clampInt(live.gray,0);

  const remain = { ...available };
  const lacks = [];

  for (const t of HEART_TYPES) {
    const need = clampInt(req[t.key],0);
    if (!need) continue;
    if (remain[t.key] < need) {
      const short = need - remain[t.key];
      lacks.push({ type:"color", key:t.key, need:short, text:`${t.label} ãŒ ${short} ä¸è¶³` });
      remain[t.key]=0;
    } else remain[t.key] -= need;
  }

  const remTotal = totalCount(remain);
  if (gray > remTotal) {
    const short = gray - remTotal;
    lacks.push({ type:"gray", need:short, text:`ç„¡è‰²ãŒ ${short} ä¸è¶³ï¼ˆè‰²ä¸å•ã®åˆè¨ˆä¸è¶³ï¼‰` });
  }

  return { ok: lacks.length===0, reason: lacks.length ? "LIVE FAILED" : "LIVE SUCCESS", detail:lacks };
}

function renderResult(res){
  resultBox.classList.remove("ok","ng");

  if (res.ok) {
    resultBox.classList.add("ok");
    resultBox.innerHTML = `<div class="big">âœ… ${res.reason}</div><div class="muted">è‰²æŒ‡å®šã‚’æº€ãŸã—ã€æ®‹ã‚Šåˆè¨ˆã§ç„¡è‰²ã‚’æ”¯æ‰•ãˆã¾ã™ã€‚</div>`;
    return;
  }

  resultBox.classList.add("ng");
  const items = (res.detail||[]).map(d=>{
    const data = d.type==="color"
      ? `data-kind="color" data-key="${esc(d.key)}" data-need="${d.need}"`
      : `data-kind="gray" data-need="${d.need}"`;
    return `<li><button class="ghost mono lackBtn" ${data} type="button"
      style="width:100%; text-align:left; padding:10px; border-radius:10px; border:1px solid #334155;">
      ${esc(d.text)}ï¼ˆã‚¿ãƒƒãƒ—ã§å¿œæ´ã«åŠ ç®—ï¼‰
    </button></li>`;
  }).join("");

  resultBox.innerHTML = `
    <div class="big">âŒ ${esc(res.reason || "LIVE FAILED")}</div>
    <ul class="list">${items}</ul>
    <div class="muted" style="margin-top:8px;">â€» ç„¡è‰²ä¸è¶³ã¯ã€ŒåŠ ç®—ã™ã‚‹è‰²ã€ã‚’é¸ã³ã¾ã™ã€‚</div>
  `;

  resultBox.querySelectorAll(".lackBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const kind = btn.dataset.kind;
      const need = clampInt(btn.dataset.need, 0);
      if (!need) return;

      if (kind==="color") {
        const key = btn.dataset.key;
        if (!key) return;
        state.support[key] = clampInt(state.support[key] + need, 0);
        renderAll(false);
        return;
      }

      const choices = HEART_TYPES.map((t,i)=>`${i+1}: ${t.label}`).join("\n");
      const picked = prompt(`ç„¡è‰²ä¸è¶³ ${need} ã‚’å¿œæ´ã«åŠ ç®—ã—ã¾ã™ã€‚\nã©ã®è‰²ã«åŠ ç®—ã—ã¾ã™ã‹ï¼Ÿï¼ˆæ•°å­—ï¼‰\n${choices}`);
      const n = Number(picked);
      if (!Number.isFinite(n) || n<1 || n>HEART_TYPES.length) return;
      const key = HEART_TYPES[n-1].key;
      state.support[key] = clampInt(state.support[key] + need, 0);
      renderAll(false);
    });
  });
}

/* =========================
   Render / Buttons
========================= */
function renderAll(rerenderSupport=true){
  renderSlots();
  renderLiveCost();
  if (rerenderSupport) renderSupport();
  else renderPills(supportSumEl, state.support, { totalLabel:"åˆè¨ˆ" });

  calcBtn.disabled = state.stage.filter(Boolean).length===0;
  livePresetBox.style.display = state.liveMode==="preset" ? "" : "none";
  liveManualBox.style.display = state.liveMode==="manual" ? "" : "none";
}

calcBtn.addEventListener("click", ()=>renderResult(calc()));

resetBtn.addEventListener("click", ()=>{
  if (!confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  state.stage = [null,null,null];
  for (const t of HEART_TYPES) state.support[t.key]=0;
  state.liveMode="preset";
  state.livePresetId=DEMO_LIVES[0].id;
  state.liveManual=null;
  setStageMode("db");
  setLiveMode("preset");
  renderAll(true);
  resultBox.className="result";
  resultBox.innerHTML = `<div class="big">æœªè¨ˆç®—</div><div class="muted">å ´ãƒ»ãƒ©ã‚¤ãƒ–ãƒ»å¿œæ´ã‚’å…¥åŠ›ã—ã¦ã€Œè¨ˆç®—ã€ã€‚ä¸è¶³ã¯ã‚¿ãƒƒãƒ—ã§å¿œæ´ã«åŠ ç®—ã§ãã¾ã™ã€‚</div>`;
});

/* =========================
   Init
========================= */
renderLiveSelect();
renderAll(true);

/* =========================
   Minimal inline PWA
========================= */
(function setupPwa(){
  const manifest = {
    name: "ãƒ©ãƒ–ã‚« ãƒãƒ¼ãƒˆè¨ˆç®—",
    short_name: "ãƒ©ãƒ–ã‚«è¨ˆç®—",
    start_url: ".",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#111827",
    icons: []
  };
  const mUrl = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
  $("manifestLink").setAttribute("href", mUrl);

  const swCode = `
    self.addEventListener('install', (e) => {
      e.waitUntil(caches.open('llhc-v1').then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
    self.addEventListener('fetch', (e) => {
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `;
  if ("serviceWorker" in navigator) {
    const swUrl = URL.createObjectURL(new Blob([swCode], {type:"text/javascript"}));
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
})();
</script>
</body>
</html>
