<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>LLTCG Heart Calc (Demo)</title>

  <link id="manifestLink" rel="manifest" href="manifest.webmanifest">

  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; }
    body { margin: 0; background: #0b1220; color: #e5e7eb; }
    header { position: sticky; top: 0; background: rgba(11,18,32,.9); backdrop-filter: blur(10px); border-bottom: 1px solid #1f2937; padding: 14px 16px; z-index: 10; }
    header h1 { margin: 0; font-size: 14px; letter-spacing: .04em; color: #cbd5e1; }
    main { padding: 14px 12px 40px; max-width: 980px; margin: 0 auto; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) { .row { grid-template-columns: 1fr 1fr; } }

    .card { background: #0f172a; border: 1px solid #1f2937; border-radius: 14px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .title { display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 10px; }
    .title h2 { margin: 0; font-size: 14px; color: #e2e8f0; }
    .muted { color: #94a3b8; font-size: 12px; }
    .mono { font-variant-numeric: tabular-nums; }
    .hr { height:1px; background:#1f2937; margin: 10px 0; }

    button, select, input { font: inherit; }
    button { background: #1f2937; color: #e5e7eb; border: 1px solid #334155; border-radius: 10px; padding: 10px 12px; cursor:pointer; }
    button.primary { background: #2563eb; border-color: #1d4ed8; }
    button.danger { background: #7f1d1d; border-color: #991b1b; }
    button.ghost { background: transparent; border-color: #334155; }
    button:disabled { opacity: .5; cursor:not-allowed; }

    select, input {
      background:#0b1220; border: 1px solid #334155; color:#e5e7eb;
      border-radius: 10px; padding: 10px 10px;
    }

    .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; border:1px solid #334155; background:#0b1220; font-size: 12px; color:#cbd5e1;}
    .kv { display:flex; flex-wrap:wrap; gap: 6px; margin-top: 8px; }
    .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .slot { border: 1px dashed #334155; border-radius: 12px; padding: 10px; min-height: 96px; background: rgba(15,23,42,.65); }
    .slot.filled { border-style: solid; }
    .slotHead { display:flex; align-items:center; justify-content:space-between; gap: 8px; }
    .slotName { font-size: 13px; color:#e2e8f0; }
    .controls { display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px; }
    .toggle { display:flex; gap:8px; }
    .toggle button { flex:1; }

    .result { padding: 12px; border-radius: 12px; border:1px solid #334155; background:#0b1220; }
    .ok { border-color: #166534; background: rgba(22,101,52,.18); }
    .ng { border-color: #991b1b; background: rgba(153,27,27,.16); }
    .big { font-size: 16px; font-weight: 800; }

    .list { margin: 8px 0 0; padding-left: 18px; color:#e2e8f0; }
    .footerHint { margin-top: 10px; color:#94a3b8; font-size: 12px; line-height: 1.4; }

    /* modal */
    .modalBack { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:999; padding: 10px; }
    .modal { max-width:560px; margin: 10vh auto; background:#0f172a; border:1px solid #334155; border-radius:14px; padding:12px; }
    .twoCol { display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    @media (max-width: 460px) { .twoCol { grid-template-columns: 1fr; } }
    .hRow { display:grid; grid-template-columns: 1fr 120px; gap: 8px; align-items:center; }
    .notice { padding: 10px; border-radius: 12px; border: 1px solid #334155; background: rgba(2,6,23,.3); }

    /* Support fixed inputs */
    .supportGrid { display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    @media (max-width: 460px) { .supportGrid { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
<header>
  <h1>LLTCG Heart Calc (Demo) â€” å ´ 1ã€œ3æš / å¿œæ´ï¼ˆå…¨è‰²å›ºå®šå…¥åŠ›ï¼‰ / ãƒ©ã‚¤ãƒ–ï¼ˆè‰²ï¼‹ç„¡è‰²ï¼‰</h1>
</header>

<main>
  <div class="row">
    <!-- Stage -->
    <section class="card">
      <div class="title">
        <h2>ã‚¹ãƒ†ãƒ¼ã‚¸</h2>
        <span class="pill mono" id="stageCount">å ´ï¼š0/3</span>
      </div>

      <div class="toggle" aria-label="stage input mode">
        <button id="modeDbBtn" class="primary" type="button">DBã‹ã‚‰é¸ã¶ï¼ˆãƒ‡ãƒ¢ï¼‰</button>
        <button id="modeManualBtn" type="button">æ‰‹å…¥åŠ›ï¼ˆå…¨ç¨®é¡ï¼‰</button>
      </div>

      <div class="hr"></div>

      <div class="grid3" id="slots"></div>

      <div class="hr"></div>

      <div class="title" style="margin-bottom:6px;">
        <h2>å ´ åˆè¨ˆ</h2>
        <span class="muted">ï¼ˆåŸºæœ¬ãƒãƒ¼ãƒˆï¼‰</span>
      </div>
      <div class="kv" id="stageSum"></div>

      <div class="footerHint">
        â€» å ´ãŒ0æšã®ã¨ãã¯è¨ˆç®—ä¸å¯ã§ã™ã€‚<br/>
        â€» æœ¬ãƒ‡ãƒ¢ã¯ã€Œæ•°å€¤è¨ˆç®—ã®ã¿ã€ã€‚åŠ¹æœ/è£å®š/ç”»åƒç­‰ã¯æ‰±ã„ã¾ã›ã‚“ã€‚
      </div>
    </section>

    <!-- Live & Support -->
    <section class="card">
      <div class="title">
        <h2>ãƒ©ã‚¤ãƒ–ï¼†å¿œæ´</h2>
        <span class="pill">ç„¡è‰²ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ã¯è‰²ä¸å•ã®å€‹æ•°æ¶ˆè²»</span>
      </div>

      <div class="notice">
        <div class="title" style="margin-bottom:6px;">
          <h2>ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰</h2>
          <div style="display:flex; gap:8px;">
            <button id="liveModePresetBtn" class="primary" type="button">ãƒ‡ãƒ¢é¸æŠ</button>
            <button id="liveModeManualBtn" class="ghost" type="button">æ‰‹å…¥åŠ›</button>
          </div>
        </div>

        <div id="livePresetBox">
          <select id="liveSelect" style="width:100%;"></select>
        </div>

        <div id="liveManualBox" style="display:none;">
          <div class="controls" style="margin-top:0;">
            <button id="openLiveModal" class="primary" type="button">ãƒ©ã‚¤ãƒ–ã‚³ã‚¹ãƒˆã‚’å…¥åŠ›</button>
            <button id="clearLiveManual" class="danger" type="button">æ‰‹å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
          </div>
          <div class="muted" style="margin-top:8px;">
            â€» æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€Œè‰²æŒ‡å®šã€ã¨ã€Œç„¡è‰²ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ã€ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="kv" id="liveCost"></div>
      </div>

      <div class="hr"></div>

      <div class="title" style="margin-bottom:6px;">
        <h2>å¿œæ´ï¼ˆå…¨è‰²å›ºå®šå…¥åŠ›ï¼‰</h2>
        <button id="supportClearBtn" class="danger" type="button">å¿œæ´ã‚’ã‚¯ãƒªã‚¢</button>
      </div>

      <div id="supportFixed" class="supportGrid"></div>

      <div class="title" style="margin-top:12px;margin-bottom:6px;">
        <h2>å¿œæ´ åˆè¨ˆ</h2>
      </div>
      <div class="kv" id="supportSum"></div>

      <div class="hr"></div>

      <div class="controls">
        <button id="calcBtn" class="primary" type="button">è¨ˆç®—</button>
        <button id="resetBtn" class="danger" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div style="margin-top:12px;" id="resultBox" class="result">
        <div class="big">æœªè¨ˆç®—</div>
        <div class="muted">å ´ã‚«ãƒ¼ãƒ‰ã¨ãƒ©ã‚¤ãƒ–ã€å¿œæ´ã‚’å…¥åŠ›ã—ã¦ã€Œè¨ˆç®—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
      </div>

      <div class="footerHint">
        ğŸ’¡ å¤±æ•—æ™‚ã®ä¸è¶³å†…è¨³ã¯ã‚¿ãƒƒãƒ—ã§ãã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å¿œæ´å…¥åŠ›ã«ä¸è¶³åˆ†ãŒè‡ªå‹•ã§åŠ ç®—ã•ã‚Œã¾ã™ã€‚<br/>
        ï¼ˆç„¡è‰²ä¸è¶³ã¯ã€åŠ ç®—ã™ã‚‹è‰²ã‚’é¸ã¹ã¾ã™ï¼‰
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:12px;">
    <div class="title">
      <h2>ä½¿ã„æ–¹ï¼ˆæœ€çŸ­ï¼‰</h2>
      <span class="muted">iPhoneã§ã‚‚OK</span>
    </div>
    <ol class="list">
      <li>å ´ã‚«ãƒ¼ãƒ‰ã‚’1ã€œ3æšå…¥ã‚Œã‚‹ï¼ˆDBé¸æŠ or æ‰‹å…¥åŠ›ï¼‰</li>
      <li>ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶ï¼ˆã¾ãŸã¯æ‰‹å…¥åŠ›ï¼‰</li>
      <li>å¿œæ´ã¯å…¨è‰²ã®å…¥åŠ›æ¬„ã«ç›´æ¥å…¥ã‚Œã‚‹</li>
      <li>å¤±æ•—æ™‚ã¯ä¸è¶³ã‚’ã‚¿ãƒƒãƒ— â†’ å¿œæ´ã«è‡ªå‹•ã§åŠ ç®—</li>
    </ol>
  </section>
</main>

<!-- Manual Input Modal (Stage card) -->
<div id="manualModal" class="modalBack" aria-hidden="true">
  <div class="modal">
    <div class="title">
      <h2 id="manualModalTitle">æ‰‹å…¥åŠ›</h2>
      <button id="manualClose" class="ghost" type="button">é–‰ã˜ã‚‹</button>
    </div>

    <input id="manualName" placeholder="åå‰ï¼ˆä»»æ„ï¼‰" style="width:100%;" />

    <div class="hr"></div>

    <div id="manualInputs" class="twoCol"></div>

    <div class="controls" style="margin-top:12px; justify-content:flex-end;">
      <button id="manualCancel" class="ghost" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="manualSave" class="primary" type="button">ä¿å­˜</button>
    </div>

    <div class="footerHint">
      â€» ãƒãƒ¼ãƒˆç¨®é¡ã¯ HEART_TYPES ã«è¿½åŠ ã™ã‚‹ã¨è‡ªå‹•ã§å¢—ãˆã¾ã™ã€‚
    </div>
  </div>
</div>

<!-- Live Input Modal -->
<div id="liveModal" class="modalBack" aria-hidden="true">
  <div class="modal">
    <div class="title">
      <h2>ãƒ©ã‚¤ãƒ–ã‚³ã‚¹ãƒˆï¼ˆæ‰‹å…¥åŠ›ï¼‰</h2>
      <button id="liveClose" class="ghost" type="button">é–‰ã˜ã‚‹</button>
    </div>

    <input id="liveName" placeholder="ãƒ©ã‚¤ãƒ–åï¼ˆä»»æ„ï¼‰" style="width:100%;" />

    <div class="hr"></div>

    <div class="muted">è‰²æŒ‡å®šã‚³ã‚¹ãƒˆ</div>
    <div id="liveColoredInputs" class="twoCol" style="margin-top:8px;"></div>

    <div class="hr"></div>

    <div class="muted">ç„¡è‰²ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ã‚³ã‚¹ãƒˆï¼šè‰²ä¸å•ã®å€‹æ•°</div>
    <input id="liveGray" type="number" min="0" step="1" class="mono" value="0" style="width:100%; margin-top:8px;" />

    <div class="controls" style="margin-top:12px; justify-content:flex-end;">
      <button id="liveCancel" class="ghost" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="liveSave" class="primary" type="button">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
const HEART_TYPES = [
  { key: "red",   label: "èµ¤" },
  { key: "blue",  label: "é’" },
  { key: "green", label: "ç·‘" },
  { key: "yellow",label: "é»„" },
  { key: "purple",label: "ç´«" },
  { key: "pink",  label: "ãƒ”ãƒ³ã‚¯" },
];

const DEMO_CARDS = [
  { id: "DEMO-001", name: "å ´ã‚«ãƒ¼ãƒ‰A", hearts: { red:1, blue:0, green:1, yellow:0, purple:0, pink:0 } },
  { id: "DEMO-002", name: "å ´ã‚«ãƒ¼ãƒ‰B", hearts: { red:0, blue:2, green:0, yellow:1, purple:0, pink:0 } },
  { id: "DEMO-003", name: "å ´ã‚«ãƒ¼ãƒ‰C", hearts: { red:1, blue:0, green:0, yellow:0, purple:1, pink:0 } },
];

const DEMO_LIVES = [
  { id: "LIVE-001", name: "ãƒ©ã‚¤ãƒ–â‘ ï¼ˆèµ¤2 é’1 + ç„¡è‰²2ï¼‰", cost: { red:2, blue:1, gray:2 } },
  { id: "LIVE-002", name: "ãƒ©ã‚¤ãƒ–â‘¡ï¼ˆç´«1 ãƒ”ãƒ³ã‚¯1 + ç„¡è‰²3ï¼‰", cost: { purple:1, pink:1, gray:3 } },
  { id: "LIVE-003", name: "ãƒ©ã‚¤ãƒ–â‘¢ï¼ˆç·‘2 é»„1 + ç„¡è‰²1ï¼‰", cost: { green:2, yellow:1, gray:1 } },
];

const state = {
  stageMode: "db",
  stage: [null, null, null],

  // å¿œæ´ã¯å…¨è‰²å›ºå®šå…¥åŠ›ï¼ˆã‚­ãƒ¼â†’æ•°ï¼‰
  supportFixed: (() => {
    const o = {};
    for (const t of HEART_TYPES) o[t.key] = 0;
    return o;
  })(),

  liveMode: "preset",
  livePresetId: DEMO_LIVES[0].id,
  liveManual: null,
};

// ---- helpers
function emptyHearts() {
  const obj = {};
  for (const t of HEART_TYPES) obj[t.key] = 0;
  return obj;
}
function normalizeHearts(h) {
  const out = emptyHearts();
  for (const k in (h || {})) if (k in out) out[k] = Number(h[k] || 0);
  return out;
}
function sumHearts(list) {
  const out = emptyHearts();
  for (const item of list) {
    if (!item) continue;
    const h = normalizeHearts(item.hearts);
    for (const k in out) out[k] += h[k];
  }
  return out;
}
function totalCount(h) {
  return Object.values(h).reduce((a,b)=>a+Number(b||0),0);
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function renderPills(container, heartsObj, options={}) {
  const { showZero=false, includeTotal=true, totalLabel="åˆè¨ˆ" } = options;
  container.innerHTML = "";
  for (const t of HEART_TYPES) {
    const v = Number(heartsObj[t.key] || 0);
    if (!showZero && v === 0) continue;
    const el = document.createElement("span");
    el.className = "pill mono";
    el.textContent = `${t.label} ${v}`;
    container.appendChild(el);
  }
  if (includeTotal) {
    const el = document.createElement("span");
    el.className = "pill mono";
    el.textContent = `${totalLabel} ${totalCount(heartsObj)}`;
    container.appendChild(el);
  }
}

// ---- elements
const slotsEl = document.getElementById("slots");
const stageSumEl = document.getElementById("stageSum");
const stageCountEl = document.getElementById("stageCount");

const modeDbBtn = document.getElementById("modeDbBtn");
const modeManualBtn = document.getElementById("modeManualBtn");

const livePresetBox = document.getElementById("livePresetBox");
const liveManualBox = document.getElementById("liveManualBox");
const liveSelectEl = document.getElementById("liveSelect");
const liveCostEl = document.getElementById("liveCost");
const liveModePresetBtn = document.getElementById("liveModePresetBtn");
const liveModeManualBtn = document.getElementById("liveModeManualBtn");
const openLiveModalBtn = document.getElementById("openLiveModal");
const clearLiveManualBtn = document.getElementById("clearLiveManual");

const supportFixedEl = document.getElementById("supportFixed");
const supportSumEl = document.getElementById("supportSum");
const supportClearBtn = document.getElementById("supportClearBtn");

const calcBtn = document.getElementById("calcBtn");
const resetBtn = document.getElementById("resetBtn");
const resultBox = document.getElementById("resultBox");

// ---- stage mode
function setStageMode(mode) {
  state.stageMode = mode;
  modeDbBtn.classList.toggle("primary", mode === "db");
  modeManualBtn.classList.toggle("primary", mode === "manual");
  renderAll();
}
modeDbBtn.addEventListener("click", () => setStageMode("db"));
modeManualBtn.addEventListener("click", () => setStageMode("manual"));

// ---- live mode
function setLiveMode(mode) {
  state.liveMode = mode;
  liveModePresetBtn.classList.toggle("primary", mode === "preset");
  liveModeManualBtn.classList.toggle("primary", mode === "manual");
  liveModePresetBtn.classList.toggle("ghost", mode !== "preset");
  liveModeManualBtn.classList.toggle("ghost", mode !== "manual");

  livePresetBox.style.display = mode === "preset" ? "" : "none";
  liveManualBox.style.display = mode === "manual" ? "" : "none";
  renderAll();
}
liveModePresetBtn.addEventListener("click", () => setLiveMode("preset"));
liveModeManualBtn.addEventListener("click", () => setLiveMode("manual"));

// ---- manual modal (stage)
const manualModal = document.getElementById("manualModal");
const manualModalTitle = document.getElementById("manualModalTitle");
const manualInputsEl = document.getElementById("manualInputs");
const manualNameEl = document.getElementById("manualName");
const manualCloseBtn = document.getElementById("manualClose");
const manualCancelBtn = document.getElementById("manualCancel");
const manualSaveBtn = document.getElementById("manualSave");
let manualEditingSlot = null;

function openManualModal(slotIdx, preset) {
  manualEditingSlot = slotIdx;
  manualModalTitle.textContent = `æ‰‹å…¥åŠ›ï¼ˆæ ${slotIdx+1}ï¼‰`;
  manualNameEl.value = preset?.name ?? `å ´ã‚«ãƒ¼ãƒ‰${slotIdx+1}`;

  manualInputsEl.innerHTML = "";
  for (const t of HEART_TYPES) {
    const wrap = document.createElement("div");
    wrap.className = "hRow";

    const label = document.createElement("div");
    label.className = "pill";
    label.textContent = t.label;

    const input = document.createElement("input");
    input.type = "number";
    input.min = "0";
    input.step = "1";
    input.className = "mono";
    input.dataset.key = t.key;
    input.value = String(preset?.hearts?.[t.key] ?? 0);

    wrap.appendChild(label);
    wrap.appendChild(input);
    manualInputsEl.appendChild(wrap);
  }

  manualModal.style.display = "block";
  manualModal.setAttribute("aria-hidden", "false");
}
function closeManualModal() {
  manualModal.style.display = "none";
  manualModal.setAttribute("aria-hidden", "true");
  manualEditingSlot = null;
}
manualCloseBtn.addEventListener("click", closeManualModal);
manualCancelBtn.addEventListener("click", closeManualModal);
manualModal.addEventListener("click", (e) => { if (e.target === manualModal) closeManualModal(); });

manualSaveBtn.addEventListener("click", () => {
  if (manualEditingSlot === null) return;

  const h = emptyHearts();
  manualInputsEl.querySelectorAll("input[data-key]").forEach(inp => {
    const k = inp.dataset.key;
    const v = Math.max(0, Math.floor(Number(inp.value || 0)));
    h[k] = v;
  });

  const name = (manualNameEl.value || "").trim() || `å ´ã‚«ãƒ¼ãƒ‰${manualEditingSlot+1}`;
  state.stage[manualEditingSlot] = { source:"manual", name, hearts: h };

  closeManualModal();
  renderAll();
});

// ---- live modal
const liveModal = document.getElementById("liveModal");
const liveCloseBtn = document.getElementById("liveClose");
const liveCancelBtn = document.getElementById("liveCancel");
const liveSaveBtn = document.getElementById("liveSave");
const liveNameEl = document.getElementById("liveName");
const liveColoredInputsEl = document.getElementById("liveColoredInputs");
const liveGrayEl = document.getElementById("liveGray");

function openLiveModal(preset) {
  liveNameEl.value = preset?.name ?? "æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–";
  liveGrayEl.value = String(Math.max(0, Math.floor(Number(preset?.gray || 0))));

  liveColoredInputsEl.innerHTML = "";
  const colored = normalizeHearts(preset?.colored || {});
  for (const t of HEART_TYPES) {
    const wrap = document.createElement("div");
    wrap.className = "hRow";

    const label = document.createElement("div");
    label.className = "pill";
    label.textContent = t.label;

    const input = document.createElement("input");
    input.type = "number";
    input.min = "0";
    input.step = "1";
    input.className = "mono";
    input.dataset.key = t.key;
    input.value = String(colored[t.key] ?? 0);

    wrap.appendChild(label);
    wrap.appendChild(input);
    liveColoredInputsEl.appendChild(wrap);
  }

  liveModal.style.display = "block";
  liveModal.setAttribute("aria-hidden","false");
}
function closeLiveModal() {
  liveModal.style.display = "none";
  liveModal.setAttribute("aria-hidden","true");
}
liveCloseBtn.addEventListener("click", closeLiveModal);
liveCancelBtn.addEventListener("click", closeLiveModal);
liveModal.addEventListener("click", (e) => { if (e.target === liveModal) closeLiveModal(); });

openLiveModalBtn.addEventListener("click", () => {
  const preset = state.liveManual
    ? { name: state.liveManual.name, colored: state.liveManual.costColored, gray: state.liveManual.gray }
    : { name: "æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–", colored: emptyHearts(), gray: 0 };
  openLiveModal(preset);
});
clearLiveManualBtn.addEventListener("click", () => {
  if (!confirm("ãƒ©ã‚¤ãƒ–æ‰‹å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  state.liveManual = null;
  renderAll();
});
liveSaveBtn.addEventListener("click", () => {
  const colored = emptyHearts();
  liveColoredInputsEl.querySelectorAll("input[data-key]").forEach(inp => {
    const k = inp.dataset.key;
    colored[k] = Math.max(0, Math.floor(Number(inp.value || 0)));
  });
  const gray = Math.max(0, Math.floor(Number(liveGrayEl.value || 0)));
  const name = (liveNameEl.value || "").trim() || "æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–";
  state.liveManual = { name, costColored: colored, gray };
  closeLiveModal();
  renderAll();
});

// ---- stage slots render
function renderSlots() {
  slotsEl.innerHTML = "";
  const count = state.stage.filter(Boolean).length;
  stageCountEl.textContent = `å ´ï¼š${count}/3`;

  for (let i=0; i<3; i++) {
    const slot = document.createElement("div");
    const item = state.stage[i];

    slot.className = "slot" + (item ? " filled" : "");
    const head = document.createElement("div");
    head.className = "slotHead";

    const name = document.createElement("div");
    name.className = "slotName mono";
    name.textContent = item ? `${item.name}` : `æ ${i+1}ï¼ˆæœªè¨­å®šï¼‰`;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "6px";

    if (item) {
      const edit = document.createElement("button");
      edit.className = "ghost";
      edit.textContent = "ç·¨é›†";
      edit.addEventListener("click", () => editSlot(i));

      const del = document.createElement("button");
      del.className = "danger";
      del.textContent = "å‰Šé™¤";
      del.addEventListener("click", () => { state.stage[i] = null; renderAll(); });

      right.appendChild(edit);
      right.appendChild(del);
    } else {
      const add = document.createElement("button");
      add.className = "primary";
      add.textContent = "+ è¿½åŠ ";
      add.addEventListener("click", () => addToSlot(i));
      right.appendChild(add);
    }

    head.appendChild(name);
    head.appendChild(right);
    slot.appendChild(head);

    const kv = document.createElement("div");
    kv.className = "kv";
    if (item) renderPills(kv, item.hearts, { showZero:false, includeTotal:false });
    slot.appendChild(kv);

    slotsEl.appendChild(slot);
  }

  const stageSum = sumHearts(state.stage.filter(Boolean));
  renderPills(stageSumEl, stageSum, { showZero:false, includeTotal:true, totalLabel:"åˆè¨ˆ" });
}

function addToSlot(slotIdx) {
  if (state.stageMode === "db") {
    const picked = prompt(
      "ãƒ‡ãƒ¢ï¼šå ´ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæ•°å­—ï¼‰\n" +
      DEMO_CARDS.map((c, idx)=>`${idx+1}: ${c.name}`).join("\n")
    );
    const n = Number(picked);
    if (!Number.isFinite(n) || n < 1 || n > DEMO_CARDS.length) return;

    const c = DEMO_CARDS[n-1];
    state.stage[slotIdx] = { source:"db", name:c.name, hearts: normalizeHearts(c.hearts) };
    renderAll();
    return;
  }
  openManualModal(slotIdx, { name: `å ´ã‚«ãƒ¼ãƒ‰${slotIdx+1}`, hearts: emptyHearts() });
}
function editSlot(slotIdx) {
  const item = state.stage[slotIdx];
  if (!item) return;

  if (state.stageMode === "db" && item.source === "db") {
    addToSlot(slotIdx);
    return;
  }
  openManualModal(slotIdx, { name: item.name, hearts: normalizeHearts(item.hearts) });
}

// ---- live preset select & cost
function renderLiveSelect() {
  liveSelectEl.innerHTML = "";
  for (const l of DEMO_LIVES) {
    const opt = document.createElement("option");
    opt.value = l.id;
    opt.textContent = l.name;
    liveSelectEl.appendChild(opt);
  }
  liveSelectEl.value = state.livePresetId;
  liveSelectEl.addEventListener("change", () => {
    state.livePresetId = liveSelectEl.value;
    renderAll(false);
  });
}
function getLiveCost() {
  if (state.liveMode === "manual") {
    if (!state.liveManual) return { name: "æ‰‹å…¥åŠ›ãƒ©ã‚¤ãƒ–ï¼ˆæœªè¨­å®šï¼‰", colored: emptyHearts(), gray: 0 };
    return { name: state.liveManual.name, colored: normalizeHearts(state.liveManual.costColored), gray: Number(state.liveManual.gray || 0) };
  }
  const live = DEMO_LIVES.find(x => x.id === state.livePresetId) || DEMO_LIVES[0];
  return { name: live.name, colored: normalizeHearts(live.cost), gray: Number(live.cost.gray || 0) };
}
function renderLiveCost() {
  const live = getLiveCost();
  liveCostEl.innerHTML = "";
  for (const t of HEART_TYPES) {
    const v = Number(live.colored[t.key] || 0);
    if (v === 0) continue;
    const el = document.createElement("span");
    el.className = "pill mono";
    el.textContent = `${t.label} å¿…è¦ ${v}`;
    liveCostEl.appendChild(el);
  }
  const el = document.createElement("span");
  el.className = "pill mono";
  el.textContent = `ç„¡è‰² å¿…è¦ ${Number(live.gray || 0)}`;
  liveCostEl.appendChild(el);
}

// ---- support fixed inputs
function renderSupportFixed() {
  supportFixedEl.innerHTML = "";
  for (const t of HEART_TYPES) {
    const wrap = document.createElement("div");
    wrap.className = "hRow";

    const label = document.createElement("div");
    label.className = "pill";
    label.textContent = t.label;

    const input = document.createElement("input");
    input.type = "number";
    input.min = "0";
    input.step = "1";
    input.className = "mono";
    input.value = String(state.supportFixed[t.key] ?? 0);
    input.addEventListener("input", () => {
      state.supportFixed[t.key] = Math.max(0, Math.floor(Number(input.value || 0)));
      renderAll(false);
    });

    wrap.appendChild(label);
    wrap.appendChild(input);
    supportFixedEl.appendChild(wrap);
  }

  renderPills(supportSumEl, state.supportFixed, { showZero:false, includeTotal:true, totalLabel:"åˆè¨ˆ" });
}
supportClearBtn.addEventListener("click", () => {
  if (!confirm("å¿œæ´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  for (const t of HEART_TYPES) state.supportFixed[t.key] = 0;
  renderAll(false);
});

// ---- calc (colored + gray)
function calc() {
  const stageCount = state.stage.filter(Boolean).length;
  if (stageCount === 0) {
    return { ok:false, reason:"å ´ã‚«ãƒ¼ãƒ‰ã‚’1æšä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚", detail:[] };
  }

  const stageSum = sumHearts(state.stage.filter(Boolean));
  const supportSum = normalizeHearts(state.supportFixed);

  const available = emptyHearts();
  for (const k in available) available[k] = stageSum[k] + supportSum[k];

  const live = getLiveCost();
  const requiredColored = normalizeHearts(live.colored);
  const requiredGray = Number(live.gray || 0);

  const remain = { ...available };
  const lacks = []; // {type:'color'|'gray', key?, need, text}

  for (const t of HEART_TYPES) {
    const need = Number(requiredColored[t.key] || 0);
    if (need <= 0) continue;

    if (remain[t.key] < need) {
      const short = need - remain[t.key];
      lacks.push({ type:"color", key:t.key, need: short, text: `${t.label} ãŒ ${short} ä¸è¶³` });
      remain[t.key] = 0;
    } else {
      remain[t.key] -= need;
    }
  }

  const remTotal = totalCount(remain);
  if (requiredGray > remTotal) {
    const short = requiredGray - remTotal;
    lacks.push({ type:"gray", need: short, text: `ç„¡è‰²ãŒ ${short} ä¸è¶³ï¼ˆè‰²ä¸å•ã®åˆè¨ˆä¸è¶³ï¼‰` });
  }

  const ok = lacks.length === 0;
  return { ok, reason: ok ? "LIVE SUCCESS" : "LIVE FAILED", detail: lacks };
}

// ---- result + tap-to-add support
function renderResult(res) {
  resultBox.classList.remove("ok","ng");

  if (res.ok) {
    resultBox.classList.add("ok");
    resultBox.innerHTML = `
      <div class="big">âœ… ${res.reason}</div>
      <div class="muted">è‰²æŒ‡å®šã‚’æº€ãŸã—ã€æ®‹ã‚Šåˆè¨ˆã§ç„¡è‰²ã‚³ã‚¹ãƒˆã‚’æ”¯æ‰•ãˆã¾ã™ã€‚</div>
    `;
    return;
  }

  resultBox.classList.add("ng");

  const itemsHtml = (res.detail || []).map((d) => {
    const data = d.type === "color"
      ? `data-kind="color" data-key="${escapeHtml(d.key)}" data-need="${d.need}"`
      : `data-kind="gray" data-need="${d.need}"`;

    return `
      <li>
        <button class="ghost mono lackBtn" ${data} type="button"
          style="width:100%; text-align:left; padding:10px; border-radius:10px; border:1px solid #334155;">
          ${escapeHtml(d.text)}ï¼ˆã‚¿ãƒƒãƒ—ã§å¿œæ´ã«åŠ ç®—ï¼‰
        </button>
      </li>
    `;
  }).join("");

  resultBox.innerHTML = `
    <div class="big">âŒ ${escapeHtml(res.reason || "LIVE FAILED")}</div>
    <ul class="list">${itemsHtml}</ul>
    <div class="muted" style="margin-top:8px;">
      â€» ç„¡è‰²ä¸è¶³ã¯ã€ŒåŠ ç®—ã™ã‚‹è‰²ã€ã‚’é¸ã³ã¾ã™ã€‚è‰²æŒ‡å®šä¸è¶³ã¯ãã®è‰²ã«è‡ªå‹•åŠ ç®—ã—ã¾ã™ã€‚
    </div>
  `;

  resultBox.querySelectorAll(".lackBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const kind = btn.dataset.kind;
      const need = Math.max(0, Math.floor(Number(btn.dataset.need || 0)));
      if (need <= 0) return;

      if (kind === "color") {
        const key = btn.dataset.key;
        if (!key) return;
        state.supportFixed[key] = Math.max(0, Math.floor(Number(state.supportFixed[key] || 0) + need));
        renderAll(false);
        return;
      }

      const choices = HEART_TYPES.map((t, i)=>`${i+1}: ${t.label}`).join("\n");
      const picked = prompt(`ç„¡è‰²ä¸è¶³ ${need} ã‚’å¿œæ´ã§åŠ ç®—ã—ã¾ã™ã€‚\nã©ã®è‰²ã«åŠ ç®—ã—ã¾ã™ã‹ï¼Ÿï¼ˆæ•°å­—ï¼‰\n${choices}`);
      const n = Number(picked);
      if (!Number.isFinite(n) || n < 1 || n > HEART_TYPES.length) return;
      const key = HEART_TYPES[n-1].key;
      state.supportFixed[key] = Math.max(0, Math.floor(Number(state.supportFixed[key] || 0) + need));
      renderAll(false);
    });
  });
}

// ---- render all
function renderAll(rerenderSupport=true) {
  renderSlots();
  renderLiveCost();
  if (rerenderSupport) renderSupportFixed();
  else renderPills(supportSumEl, state.supportFixed, { showZero:false, includeTotal:true, totalLabel:"åˆè¨ˆ" });

  const stageCount = state.stage.filter(Boolean).length;
  calcBtn.disabled = stageCount === 0;

  livePresetBox.style.display = state.liveMode === "preset" ? "" : "none";
  liveManualBox.style.display = state.liveMode === "manual" ? "" : "none";
}

// ---- buttons
calcBtn.addEventListener("click", () => renderResult(calc()));

resetBtn.addEventListener("click", () => {
  if (!confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  state.stage = [null, null, null];
  for (const t of HEART_TYPES) state.supportFixed[t.key] = 0;
  state.liveMode = "preset";
  state.livePresetId = DEMO_LIVES[0].id;
  state.liveManual = null;

  setStageMode("db");
  setLiveMode("preset");

  renderAll();
  resultBox.className = "result";
  resultBox.innerHTML = `<div class="big">æœªè¨ˆç®—</div><div class="muted">å ´ã‚«ãƒ¼ãƒ‰ã¨ãƒ©ã‚¤ãƒ–ã€å¿œæ´ã‚’å…¥åŠ›ã—ã¦ã€Œè¨ˆç®—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>`;
});

// ---- init
renderLiveSelect();
renderAll();

// ---- minimal PWA inlined
(function setupPwaFiles() {
  const manifest = {
    name: "LLTCG Heart Calc (Demo)",
    short_name: "HeartCalc",
    start_url: ".",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#111827",
    icons: []
  };
  const mBlob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
  const mUrl = URL.createObjectURL(mBlob);
  document.getElementById("manifestLink").setAttribute("href", mUrl);

  const swCode = `
    self.addEventListener('install', (e) => {
      e.waitUntil(caches.open('hc-demo-v3').then(cache => cache.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
    self.addEventListener('fetch', (e) => {
      e.respondWith(caches.match(e.request).then(resp => resp || fetch(e.request)));
    });
  `;
  if ("serviceWorker" in navigator) {
    const swBlob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
})();
</script>
</body>
</html>
